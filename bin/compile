#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e
set -o pipefail

# debug
# set -x

# clean up leaking environment
unset GIT_DIR

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
BUILDPACK_DIR=$(cd $(dirname $0)/..; pwd)

MAPNIK_VARIANT=${MAPNIK_VARIANT:-master}

PATH=$PATH:$BUILD_DIR/vendor/node/bin

# include .files when moving things around
shopt -s dotglob

function error() {
  echo " !     $*" >&2
  exit 1
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

echo
echo "-----> Installing Dependencies"

cat <<EOF > $BUILD_DIR/package.json
{
  "name": "map",
  "description": "Map",
  "repository": "n/a",
  "engines": {
    "node": "~0.10.20"
  },
  "dependencies": {
    "js-yaml": "~2.1.3",
    "tileserver": "https://$GITHUB_TOKEN:x-oauth-basic@github.com/mojodna/vector-tile-server/tarball/master?$(date '+%s')"
  }
}
EOF

if [ ! -e $BUILD_DIR/README.md ]; then
  echo . > $BUILD_DIR/README.md
fi

BUILDPACKS="https://bitbucket.org/mojodna/heroku-buildpack-mapnik-deps.git#${MAPNIK_VARIANT} \
            https://github.com/mojodna/heroku-buildpack-nodejs.git#diet"

for BUILDPACK in $BUILDPACKS; do
  dir=$(mktemp -t buildpackXXXXX)
  rm -rf $dir

  url=${BUILDPACK%#*}
  branch=${BUILDPACK#*#}

  if [ "$branch" == "$url" ]; then
    branch=""
  fi

  if [ "$url" != "" ]; then
    echo "=====> Downloading Buildpack: $url"

    if [[ "$url" =~ \.tgz$ ]]; then
      mkdir -p "$dir"
      curl -s "$url" | tar xvz -C "$dir" >/dev/null 2>&1
    else
      git clone $url $dir >/dev/null 2>&1
    fi
    cd $dir

    if [ "$branch" != "" ]; then
      git checkout $branch >/dev/null 2>&1
    fi

    # we'll get errors later if these are needed and don't exist
    chmod -f +x $dir/bin/{detect,compile,release} || true

    framework=$($dir/bin/detect $1)

    if [ $? == 0 ]; then
      echo "=====> Detected Framework: $framework"
      $dir/bin/compile $1 $2

      if [ $? != 0 ]; then
        exit 1
      fi

      # check if the buildpack left behind an environment for subsequent ones
      if [ -e $dir/export ]; then
        source $dir/export
      fi

      if [ -x $dir/bin/release ]; then
        $dir/bin/release $1 > $1/last_pack_release.out
      fi
    fi
  fi
done

# TODO fully necessary?
PATH=$PATH:$BUILD_DIR/vendor/node/bin:$BUILD_DIR/node_modules/.bin:$BUILD_DIR/node_modules/tileserver/node_modules/.bin
export NODE_PATH="$BUILD_DIR/node_modules:$NODE_PATH"
export LD_LIBRARY_PATH="$BUILD_DIR/vendor/gdal/lib:$BUILD_DIR/vendor/proj/lib:$LD_LIBRARY_PATH"

if [ -f $BUILD_DIR/project.yml ]; then
  echo "-----> Pre-processing map style"

  js-yaml --to-json $BUILD_DIR/project.yml > $BUILD_DIR/project.mml
fi

if [ -f $BUILD_DIR/project.mml ]; then
  echo "-----> Compiling map style"

  millstone -n $BUILD_DIR/project.mml 2>&1 > $BUILD_DIR/project2.mml | indent
  carto -n $BUILD_DIR/project2.mml 2>&1 > $BUILD_DIR/stylesheet.xml | indent
  rm $BUILD_DIR/project2.mml

  sed -i 's%/tmp/millstone-test%/app/map/layers%g' $BUILD_DIR/stylesheet.xml

  if [ -d /tmp/millstone-test ]; then
    mkdir -p $BUILD_DIR/layers
    mv /tmp/millstone-test/* $BUILD_DIR/layers/
  fi
fi

echo "-----> Building runtime environment"
mkdir -p $BUILD_DIR/.profile.d

cat <<EOF > $BUILD_DIR/.profile.d/map.sh
export NODE_ENV=production
export UV_THREADPOOL_SIZE=16
EOF

echo "-----> Cleaning up"

rm $BUILD_DIR/package.json
